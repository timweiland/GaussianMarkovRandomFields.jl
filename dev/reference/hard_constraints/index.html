<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Hard Constraints · GaussianMarkovRandomFields.jl</title><meta name="title" content="Hard Constraints · GaussianMarkovRandomFields.jl"/><meta property="og:title" content="Hard Constraints · GaussianMarkovRandomFields.jl"/><meta property="twitter:title" content="Hard Constraints · GaussianMarkovRandomFields.jl"/><meta name="description" content="Documentation for GaussianMarkovRandomFields.jl."/><meta property="og:description" content="Documentation for GaussianMarkovRandomFields.jl."/><meta property="twitter:description" content="Documentation for GaussianMarkovRandomFields.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/citations.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="GaussianMarkovRandomFields.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">GaussianMarkovRandomFields.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/">Overview</a></li><li><a class="tocitem" href="../../tutorials/autoregressive_models/">Building autoregressive models</a></li><li><a class="tocitem" href="../../tutorials/spatial_modelling_spdes/">Spatial Modelling with SPDEs</a></li><li><a class="tocitem" href="../../tutorials/spatiotemporal_modelling/">Spatiotemporal Modelling with SPDEs</a></li><li><a class="tocitem" href="../../tutorials/boundary_conditions/">Boundary Conditions for SPDEs</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">API Reference</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../gmrfs/">GMRFs</a></li><li><a class="tocitem" href="../latent_models/">Latent Models</a></li><li><a class="tocitem" href="../observation_models/">Observation Models</a></li><li><a class="tocitem" href="../gaussian_approximation/">Gaussian Approximation</a></li><li class="is-active"><a class="tocitem" href>Hard Constraints</a><ul class="internal"><li><a class="tocitem" href="#Mathematical-Foundation"><span>Mathematical Foundation</span></a></li><li><a class="tocitem" href="#Basic-Usage-Pattern"><span>Basic Usage Pattern</span></a></li><li><a class="tocitem" href="#Examples"><span>Examples</span></a></li><li><a class="tocitem" href="#Gaussian-Approximation-with-Constraints"><span>Gaussian Approximation with Constraints</span></a></li><li><a class="tocitem" href="#API-Reference"><span>API Reference</span></a></li></ul></li><li><a class="tocitem" href="../spdes/">SPDEs</a></li><li><a class="tocitem" href="../discretizations/">Discretizations</a></li><li><a class="tocitem" href="../meshes/">Meshes</a></li><li><a class="tocitem" href="../plotting/">Plotting</a></li><li><a class="tocitem" href="../solvers/">Solvers</a></li><li><a class="tocitem" href="../autoregressive/">Autoregressive Models</a></li><li><a class="tocitem" href="../linear_maps/">Linear maps</a></li><li><a class="tocitem" href="../preconditioners/">Preconditioners</a></li></ul></li><li><a class="tocitem" href="../../bibliography/">Bibliography</a></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Developer Documentation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../dev-docs/">Overview</a></li><li><a class="tocitem" href="../../dev-docs/solvers/">Solvers</a></li><li><a class="tocitem" href="../../dev-docs/spdes/">SPDEs</a></li><li><a class="tocitem" href="../../dev-docs/discretizations/">Discretizations</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">API Reference</a></li><li class="is-active"><a href>Hard Constraints</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Hard Constraints</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/timweiland/GaussianMarkovRandomFields.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/timweiland/GaussianMarkovRandomFields.jl/blob/main/docs/src/reference/hard_constraints.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Hard-Constraints"><a class="docs-heading-anchor" href="#Hard-Constraints">Hard Constraints</a><a id="Hard-Constraints-1"></a><a class="docs-heading-anchor-permalink" href="#Hard-Constraints" title="Permalink"></a></h1><p>Many applications require probabilistic models to satisfy hard equality constraints. For instance, in spatial statistics we might need mass conservation (sum of values equals zero), or in engineering applications we might require boundary conditions to be exactly satisfied. The <code>ConstrainedGMRF</code> type enables efficient Bayesian inference under linear equality constraints while preserving the computational advantages of sparse precision matrices.</p><p>A <code>ConstrainedGMRF</code> represents the conditional distribution x | Ax = e, where x follows an unconstrained GMRF prior and A, e define the linear constraints. Despite the resulting distribution being degenerate (the precision matrix becomes singular), all essential operations—sampling, mean computation, variance calculation, and further conditioning—remain computationally efficient through conditioning by Kriging.</p><p>The key insight is that while the constrained distribution has infinite precision in the constraint directions, it retains finite variance in the orthogonal complement, enabling meaningful inference.</p><h2 id="Mathematical-Foundation"><a class="docs-heading-anchor" href="#Mathematical-Foundation">Mathematical Foundation</a><a id="Mathematical-Foundation-1"></a><a class="docs-heading-anchor-permalink" href="#Mathematical-Foundation" title="Permalink"></a></h2><p>Given an unconstrained GMRF x ~ N(μ, Q⁻¹) and linear constraints Ax = e, the constrained distribution has:</p><p><strong>Constrained mean:</strong></p><pre><code class="nohighlight hljs">μ_c = μ - Q⁻¹A^T(AQ⁻¹A^T)⁻¹(Aμ - e)</code></pre><p><strong>Constrained covariance:</strong></p><pre><code class="nohighlight hljs">Σ_c = Q⁻¹ - Q⁻¹A^T(AQ⁻¹A^T)⁻¹AQ⁻¹</code></pre><p><strong>Sampling via Kriging:</strong></p><pre><code class="nohighlight hljs">x_c = x - Q⁻¹A^T(AQ⁻¹A^T)⁻¹(Ax - e)</code></pre><p>where x is drawn from the unconstrained distribution.</p><h2 id="Basic-Usage-Pattern"><a class="docs-heading-anchor" href="#Basic-Usage-Pattern">Basic Usage Pattern</a><a id="Basic-Usage-Pattern-1"></a><a class="docs-heading-anchor-permalink" href="#Basic-Usage-Pattern" title="Permalink"></a></h2><pre><code class="language-julia hljs"># Step 1: Set up unconstrained prior GMRF
prior_gmrf = GMRF(μ_prior, Q_prior)

# Step 2: Define linear constraints Ax = e
A = constraint_matrix  # m × n matrix
e = constraint_vector  # m-dimensional vector

# Step 3: Create constrained GMRF
constrained_gmrf = ConstrainedGMRF(prior_gmrf, A, e)

# Step 4: Use like any other GMRF
constrained_sample = rand(constrained_gmrf)
constrained_mean = mean(constrained_gmrf)
marginal_vars = var(constrained_gmrf)</code></pre><h2 id="Examples"><a class="docs-heading-anchor" href="#Examples">Examples</a><a id="Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Examples" title="Permalink"></a></h2><h3 id="Sum-to-Zero-Constraint"><a class="docs-heading-anchor" href="#Sum-to-Zero-Constraint">Sum-to-Zero Constraint</a><a id="Sum-to-Zero-Constraint-1"></a><a class="docs-heading-anchor-permalink" href="#Sum-to-Zero-Constraint" title="Permalink"></a></h3><p>A common constraint in spatial modeling ensures mass conservation:</p><pre><code class="language-julia hljs">using GaussianMarkovRandomFields, LinearAlgebra, SparseArrays

# Prior: independent components
n = 5
prior_gmrf = GMRF(ones(n), spdiagm(0 =&gt; ones(n)))

# Constraint: sum equals zero
A = ones(1, n)  # 1×5 matrix [1 1 1 1 1]
e = [0.0]       # sum = 0

# Constrained GMRF
constrained_gmrf = ConstrainedGMRF(prior_gmrf, A, e)

# Verify constraint satisfaction
x = rand(constrained_gmrf)
@assert abs(sum(x)) &lt; 1e-10  # Constraint satisfied to numerical precision

# Linear conditioning also works seamlessly
y_obs = [0.3, -0.1]  # Observe first two components
A_obs = sparse([1.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0])
conditioned = linear_condition(constrained_gmrf; A=A_obs, Q_ϵ=10.0, y=y_obs)</code></pre><h3 id="Multiple-Constraints"><a class="docs-heading-anchor" href="#Multiple-Constraints">Multiple Constraints</a><a id="Multiple-Constraints-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-Constraints" title="Permalink"></a></h3><p>Complex applications often require multiple simultaneous constraints:</p><pre><code class="language-julia hljs"># System with 4 variables
n = 4
prior_gmrf = GMRF(zeros(n), spdiagm(0 =&gt; ones(n)))

# Two constraints:
# 1. Sum equals zero: x₁ + x₂ + x₃ + x₄ = 0  
# 2. Symmetry: x₁ = x₂
A = [1.0 1.0 1.0 1.0;    # Sum constraint
     1.0 -1.0 0.0 0.0]   # Symmetry constraint
e = [0.0, 0.0]

constrained_gmrf = ConstrainedGMRF(prior_gmrf, A, e)

# Both constraints are automatically satisfied
x = rand(constrained_gmrf)
@assert abs(sum(x)) &lt; 1e-10           # Sum = 0
@assert abs(x[1] - x[2]) &lt; 1e-10      # x₁ = x₂</code></pre><h3 id="Boundary-Conditions-in-Spatial-Models"><a class="docs-heading-anchor" href="#Boundary-Conditions-in-Spatial-Models">Boundary Conditions in Spatial Models</a><a id="Boundary-Conditions-in-Spatial-Models-1"></a><a class="docs-heading-anchor-permalink" href="#Boundary-Conditions-in-Spatial-Models" title="Permalink"></a></h3><p>In PDE-based spatial models, boundary conditions are naturally expressed as constraints:</p><pre><code class="language-julia hljs"># Spatial grid with fixed boundary values
n_interior = 16  # Interior points
n_boundary = 8   # Boundary points  
n_total = n_interior + n_boundary

# Prior on interior + boundary points
prior_gmrf = MaternSPDE(mesh, ν=1.5, κ=1.0)  # Some spatial prior

# Constraint: fix boundary values
A = [zeros(n_boundary, n_interior) I(n_boundary)]  # Select boundary points
e = boundary_values  # Known boundary conditions

constrained_gmrf = ConstrainedGMRF(prior_gmrf, A, e)</code></pre><p>Constraints are also commonly used for identifiability in hierarchical models (e.g., sum-to-zero constraints on random effects in INLA-style modeling).</p><h2 id="Gaussian-Approximation-with-Constraints"><a class="docs-heading-anchor" href="#Gaussian-Approximation-with-Constraints">Gaussian Approximation with Constraints</a><a id="Gaussian-Approximation-with-Constraints-1"></a><a class="docs-heading-anchor-permalink" href="#Gaussian-Approximation-with-Constraints" title="Permalink"></a></h2><p>The real power emerges when combining constrained priors with non-Gaussian observation models. For non-conjugate cases, the <code>gaussian_approximation</code> function uses Fisher scoring while automatically respecting constraints throughout optimization:</p><pre><code class="language-julia hljs"># Constrained prior for log-rates (sum-to-zero for identifiability)
n = 6
prior_gmrf = GMRF(zeros(n), spdiagm(0 =&gt; ones(n)))
A = ones(1, n)
e = [0.0]
constrained_prior = ConstrainedGMRF(prior_gmrf, A, e)

# Poisson observations
obs_model = ExponentialFamily(Poisson)
y_counts = [5, 2, 8, 3, 6, 1]
obs_lik = obs_model(y_counts)

# Constrained Gaussian approximation to posterior
constrained_posterior = gaussian_approximation(constrained_prior, obs_lik)

# All samples from posterior satisfy the constraint
posterior_sample = rand(constrained_posterior)
@assert abs(sum(posterior_sample)) &lt; 1e-10</code></pre><p>For conjugate cases (Normal observations), specialized dispatches automatically use exact <code>linear_condition</code> instead of iterative optimization.</p><h2 id="API-Reference"><a class="docs-heading-anchor" href="#API-Reference">API Reference</a><a id="API-Reference-1"></a><a class="docs-heading-anchor-permalink" href="#API-Reference" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="GaussianMarkovRandomFields.ConstrainedGMRF" href="#GaussianMarkovRandomFields.ConstrainedGMRF"><code>GaussianMarkovRandomFields.ConstrainedGMRF</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">ConstrainedGMRF{T,L,G} &lt;: AbstractGMRF{T,L}</code></pre><p>A Gaussian Markov Random Field with hard linear equality constraints.</p><p>Given an unconstrained GMRF x ~ N(μ, Q⁻¹) and constraints Ax = e, this represents the constrained distribution x | Ax = e.</p><p>This is a degenerate distribution (the precision matrix becomes singular), but sampling and mean computation are handled efficiently using conditioning by Kriging.</p><p><strong>Mathematical Background</strong></p><p>For x ~ N(μ, Q⁻¹) with constraint Ax = e, the constrained mean is:     μ_c = μ - Q⁻¹A^T(AQ⁻¹A^T)⁻¹(Aμ - e)</p><p>And samples are obtained via:     x_c = x - Q⁻¹A^T(AQ⁻¹A^T)⁻¹(Ax - e)</p><p>where x is a sample from the unconstrained distribution.</p><p>The constrained covariance matrix is:     Σ_c = Q⁻¹ - Q⁻¹A^T(AQ⁻¹A^T)⁻¹AQ⁻¹</p><p><strong>Implementation</strong></p><p>For efficiency, the constructor precomputes:</p><ul><li>Ã^T = Q⁻¹A^T (via solving QL^T = A^T where Q = LL^T)</li><li>L_c from Cholesky factorization of AÃ^T</li><li>B = L^(-T)Ã^T L_c^(-T) for variance computations</li></ul><p><strong>Type Parameters</strong></p><ul><li><code>T&lt;:Real</code>: The numeric type</li><li><code>L&lt;:Union{LinearMaps.LinearMap{T}, AbstractMatrix{T}}</code>: The precision map type</li><li><code>G&lt;:AbstractGMRF{T,L}</code>: The concrete type of the base GMRF</li></ul><p><strong>Fields</strong></p><ul><li><code>base_gmrf::G</code>: The unconstrained GMRF</li><li><code>constraint_matrix::Matrix{T}</code>: Constraint matrix A (converted to dense)</li><li><code>constraint_vector::Vector{T}</code>: Constraint vector e</li><li><code>A_tilde_T::Matrix{T}</code>: Precomputed Q⁻¹A^T</li><li><code>L_c::Cholesky{T, Matrix{T}}</code>: Cholesky factorization of AÃ^T</li><li><code>constrained_mean::Vector{T}</code>: Precomputed constrained mean</li></ul><p><strong>Constructor</strong></p><pre><code class="nohighlight hljs">ConstrainedGMRF(base_gmrf::AbstractGMRF, A, e)</code></pre><p>Create a constrained GMRF where <code>base_gmrf</code> is the unconstrained distribution, <code>A</code> is the constraint matrix, and <code>e</code> is the constraint vector such that Ax = e.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/timweiland/GaussianMarkovRandomFields.jl/blob/39d819cd96fe04b1cbf04570c7357444eb6879c9/src/arithmetic/constrained.jl#L9-L58">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../gaussian_approximation/">« Gaussian Approximation</a><a class="docs-footer-nextpage" href="../spdes/">SPDEs »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Wednesday 27 August 2025 18:28">Wednesday 27 August 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
